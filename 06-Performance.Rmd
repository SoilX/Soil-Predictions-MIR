# Model Results

## Get Results {-}
### `getModResults()` {-}

* `getModResults( {see below} )`
    + `PROP`: *string*- The column name of the soil property of interest.
    + `MODTYPE`: *string*- "MBL" or "PLS"
    + `MODNAME`: *string*- The name of the model variable, if it is already loaded into the R environment. Use MODNAME or MODPATH 
    + `MODPATH`: *string*- The path the the RData file containing your model, if the model is not already loaded. Use MODNAME or MODPATH
    + `PREDNAME`: *string*- The name of the prediction set variable, if it is already loaded into the R environment, that will be used to create the model. Use PREDNAME or PREDPATH
    + `PREDPATH`: *string*- The path the the RData file containing your prediction set, if the prediction set is not already loaded. PREDNAME or PREDPATH
    + `SAVEPRED`: *boolean*- Whether or not to save the predictions. If TRUE, predictions will be saved to the folder 'Predictions' using the function `savePredictions()`. Default is set to TRUE
    + `MODPERF`: *boolean*- Whether or not to generate and show the prediction performance statistics. If TRUE, these statistics will be generated by the `getModStats()` function, and saved in the folder 'Predictions' in the performance log.
    

```{r, eval=FALSE}
getModResults <- function(PROP, MODTYPE, MODNAME=NA, MODPATH=NA, PREDNAME=NA, PREDPATH=NA, SAVEPRED=TRUE, MODPERF=TRUE){
  
  # Load Model
  if(!is.na(MODPATH)){
    MODNAME <- load(MODPATH)
  }
  model <- get(MODNAME)
  
  # Extract Predictions
  if(MODTYPE=="MBL"){
    ncomp_onesigma <- NA
    pred_type <- NA
    predictions <- getPredMBL(model)
  }
  
  # Load Prediction Set
  if(MODTYPE=="PLS"){
    predType <- "predict"
    if(!is.na(PREDNAME)){
      predSet <- get(PREDNAME)
    }
    if(!is.na(PREDPATH)){
      PREDNAME <- load(PREDPATH)
      predSet <- get(PREDNAME)
    }else{
      predType <- "fitted"
    }
  
  
    # Find Optimal Number of Components
    ncomp_onesigma <- selectNcomp(model, method = "onesigma", plot=TRUE, main=PROP)
    # Get Predictions
    predictions <- getPredPLS(model, ncomp_onesigma, predType, predSet)
  }
  
  # Get Pred Versus Observations
  lab_data <- predSet[,PROP] # Lab Data
  predobs <- data.frame(predSet[,"sample_id"], predictions, lab_data)
  names(predobs) <- c("sample_id","pred","obs")
  
  # {Optional} Model Performance
  if(MODPERF==TRUE){
    modstats <- getModStats(PREDOBS= predobs, PROP=PROP, NCOMP=ncomp_onesigma, MODNAME=MODNAME, 
                            PREDTYPE= pred_type, PREDNAME=PREDNAME, SAVE=TRUE)
  }
  # {Optional} Save Predictions
  if(SAVEPRED==TRUE){
    savePredictions(predobs, PROP, MODTYPE, PREDNAME)
  }
  names(predobs) <- c("sample_id", paste0(PROP,".",MODTYPE), PROP)
  return(predobs)
}

```
## Predictions {-}
Predictions are extracting using either `getPredPLS()` or `getPredMBL()`. These are called within `getModResults()` before being saved. The following functions save predictions to a file unique to each prediction set. If this file already exists, it simply adds another column of predictions. If it does not, it will create the file to save predictions in from the original prediction set.    

### getSavePredTable() {-}
```{r, eval=FALSE}
getSavePredTable <- function(PREDNAME){
  
  if(file.exists("./Predictions")==FALSE){dir.create("./Predictions")}
  
  predSavePath <- paste0("./Predictions/", PREDNAME, "_predictions.csv")
  if(file.exists(predSavePath) ){
    all_predictions <- read.csv(predSavePath)
  }else{
    predSet <- get(PREDNAME)
    all_predictions <- predSet[,-ncol(predSet)] # remove spectra, last column
  }
  
  return(all_predictions)
}
```

### getSavePredTable() {-}
```{r, eval=FALSE}
savePredictions <- function(PREDOBS, PROP, MODTYPE, PREDNAME){
  all_predictions <- getSavePredTable(PREDNAME) # Make/Load file to save predictions
  savename <- paste(PROP,MODTYPE,sep=".") # Ex: OC.PLSR
  
  if(!(savename %in% names(all_predictions))){
    
    all_predictions <- merge(all_predictions, PREDOBS[,1:2] , all.X=TRUE) # Merge with all_predictions
    ncolm <- ncol(all_predictions)
    names(all_predictions)[ncolm] <- savename
    savefile <- paste0("Predictions/", PREDNAME,"_predictions.csv") # Set file savename
    write.csv(all_predictions, file=savefile, row.names=FALSE) # Save
    
    print(paste("Predictions saved to", savefile)) # Print save location
    
  }else{
    print("Column already exists")
  }
  
  View(all_predictions)
}
```


## Statistics {-}
### getModStats() {-}
```{r, eval=FALSE}
getModStats <- function(PREDOBS, PROP, NCOMP=NA, MODNAME=NA, PREDTYPE=NA, PREDNAME=NA, SAVE=FALSE){
  
  print(paste(PROP, "Summary"))
  TIME <- as.character(Sys.time()[1])
  
  # Regress predicted versus observed
  PREDOBS <- na.omit(PREDOBS)
  reg_mod <- lm(PREDOBS$pred ~ PREDOBS$obs)
  sum_perf <- summary(reg_mod)
  
  # Get statistics
  R2 <- round(sum_perf$r.squared,4)
  R2_adj <- round(sum_perf$adj.r.squared,4)
  b0 <- round(sum_perf$coefficients[1], 2) # Y-Intercept
  b1 <- round(sum_perf$coefficients[2],2) # Slope
  RMSE <- round(sqrt(mean((PREDOBS$pred - PREDOBS$obs)^2)),2)
  bias <- round((sum(PREDOBS$pred, na.rm=TRUE)- sum(PREDOBS$obs, na.rm=TRUE))/length(PREDOBS$obs),2)
  std <- round(sd(PREDOBS$pred, na.rm=TRUE),2) # Standard Deviation
  rpd <- round(std / RMSE,2) # Residual Prediction Deviation
  
  # Assemble Row
  modStats <- data.frame(Timestamp=TIME, Property=PROP, Mod_Name=MODNAME, Pred_Type=PREDTYPE,
                         Pred_Data=PREDNAME, ncomp=NCOMP, R2=R2, R2_Adj=R2_adj, Y_Int=b0, Slope=b1,
                         RMSE=RMSE, bias=bias,STD=std, RPD=rpd)
  
  # Write Row 
  if(SAVE==TRUE){saveModStats(modStats)}
  
  # Plot Pred Obs
  plot.plsr(PREDOBS$obs, PREDOBS$pred, modStats, paste(MODNAME,PREDNAME,"Predictions"), "")
  
  # Print Statistics
  print(t(modStats))
  
  return(modStats)
} # End of getModStats
```

![](images/stats.png)

### saveModStats() {-}

```{r eval=FALSE}
saveModStats <- function(MODSTATS){
  
  if(file.exists("./Predictions")==FALSE){dir.create("./Predictions")}
  
  modStats_file <- "Predictions/prediction_performance.csv"
  if(file.exists(modStats_file)==FALSE){
    write.csv(MODSTATS, file = modStats_file, row.names=FALSE)
  }else{
    save_table <- read.csv(modStats_file)
    save_table <- rbind(save_table,MODSTATS)
    write.csv(save_table, modStats_file, row.names=FALSE)
  }
  print(paste("Statistics saved to", modStats_file))
}
```

## Plots {-}
The following function creates a scatter plot of the observed lab data against the predictions, showing the line of best fit and its equation, as well as some summary statistics.    

### `plotPred()` {-}

```{r eval=FALSE}
plotPred <- function(x,y, stats, name=NA, units=NA){
  max <- max(c(x,y))
  lims = c(0,(1.1*max))
  plot(y ~ x, 
       ylab = paste("Predicted", units), 
       xlab=paste("Observed", units), 
       xlim = lims,
       ylim=lims,main = paste(name))
  
  
  reg_model <-lm(y~x)
  abline(reg_model)

  topstats <- bquote(R^2 == .(stats$R2) * "," ~~italic(bias)== .(stats$bias) * "," ~~ RMSE == .(stats$RMSE))
  text(min(x,y),max(x,y), topstats, pos = 4, col="blue")
  
  eqn <- bquote(y== .(stats$Slope) * "x"  * " + " * .(stats$Y_Int))
  text(min(x,y),max(x,y)-(max(x,y)-min(x,y))/10, eqn, pos = 4, col="blue")
}
```
![](images/predplot.png)

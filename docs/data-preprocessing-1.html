<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>8 Data Preprocessing | Soil Predictions using MIR-Spectroscopy</title>
  <meta name="description" content="8 Data Preprocessing | Soil Predictions using MIR-Spectroscopy" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="8 Data Preprocessing | Soil Predictions using MIR-Spectroscopy" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="8 Data Preprocessing | Soil Predictions using MIR-Spectroscopy" />
  
  
  

<meta name="author" content="Charlotte Rivard" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="references.html"/>

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Soil Predictions using MIR-Spectroscopy</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="background.html"><a href="background.html"><i class="fa fa-check"></i><b>2</b> Background</a></li>
<li class="chapter" data-level="3" data-path="code-overview.html"><a href="code-overview.html"><i class="fa fa-check"></i><b>3</b> Code Overview</a><ul>
<li class="chapter" data-level="3.1" data-path="code-overview.html"><a href="code-overview.html#file-structure"><i class="fa fa-check"></i><b>3.1</b> File Structure</a></li>
<li class="chapter" data-level="3.2" data-path="code-overview.html"><a href="code-overview.html#required-packages"><i class="fa fa-check"></i><b>3.2</b> Required Packages</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-preprocessing.html"><a href="data-preprocessing.html"><i class="fa fa-check"></i><b>4</b> Data Preprocessing</a><ul>
<li class="chapter" data-level="4.1" data-path="data-preprocessing.html"><a href="data-preprocessing.html#extract-opus-files"><i class="fa fa-check"></i><b>4.1</b> Extract OPUS files</a></li>
<li class="chapter" data-level="4.2" data-path="data-preprocessing.html"><a href="data-preprocessing.html#process-spectra"><i class="fa fa-check"></i><b>4.2</b> Process Spectra</a></li>
<li class="chapter" data-level="4.3" data-path="data-preprocessing.html"><a href="data-preprocessing.html#merge-with-lab-data"><i class="fa fa-check"></i><b>4.3</b> Merge with Lab Data</a></li>
<li class="chapter" data-level="4.4" data-path="data-preprocessing.html"><a href="data-preprocessing.html#select-calibration-set"><i class="fa fa-check"></i><b>4.4</b> (Select Calibration Set)</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="plsr-models.html"><a href="plsr-models.html"><i class="fa fa-check"></i><b>5</b> PLSR Models</a><ul>
<li class="chapter" data-level="5.1" data-path="plsr-models.html"><a href="plsr-models.html#model-theory"><i class="fa fa-check"></i><b>5.1</b> Model Theory</a></li>
<li class="chapter" data-level="5.2" data-path="plsr-models.html"><a href="plsr-models.html#making-plsr-models"><i class="fa fa-check"></i><b>5.2</b> Making PLSR Models</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="mbl-models.html"><a href="mbl-models.html"><i class="fa fa-check"></i><b>6</b> MBL Models</a><ul>
<li class="chapter" data-level="6.1" data-path="mbl-models.html"><a href="mbl-models.html#model-theory-1"><i class="fa fa-check"></i><b>6.1</b> Model Theory</a><ul>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#overview"><i class="fa fa-check"></i>Overview</a></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#animation"><i class="fa fa-check"></i>Animation</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="mbl-models.html"><a href="mbl-models.html#making-mbl-predictions"><i class="fa fa-check"></i><b>6.2</b> Making MBL Predictions</a><ul>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#mbl-functions"><i class="fa fa-check"></i>MBL Functions</a></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#modeling-parameters"><i class="fa fa-check"></i>Modeling Parameters</a></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#sample-code"><i class="fa fa-check"></i>Sample Code</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="model-performance.html"><a href="model-performance.html"><i class="fa fa-check"></i><b>7</b> Model Performance</a><ul>
<li class="chapter" data-level="7.1" data-path="model-performance.html"><a href="model-performance.html#statistics"><i class="fa fa-check"></i><b>7.1</b> Statistics</a></li>
<li class="chapter" data-level="7.2" data-path="model-performance.html"><a href="model-performance.html#plots"><i class="fa fa-check"></i><b>7.2</b> Plots</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="chapter" data-level="8" data-path="data-preprocessing-1.html"><a href="data-preprocessing-1.html"><i class="fa fa-check"></i><b>8</b> Data Preprocessing</a><ul>
<li class="chapter" data-level="8.1" data-path="data-preprocessing-1.html"><a href="data-preprocessing-1.html#extract-opus-files-1"><i class="fa fa-check"></i><b>8.1</b> Extract OPUS files</a></li>
<li class="chapter" data-level="8.2" data-path="data-preprocessing-1.html"><a href="data-preprocessing-1.html#process-spectra-1"><i class="fa fa-check"></i><b>8.2</b> Process Spectra</a></li>
<li class="chapter" data-level="8.3" data-path="data-preprocessing-1.html"><a href="data-preprocessing-1.html#merge-with-lab-data-1"><i class="fa fa-check"></i><b>8.3</b> Merge with Lab Data</a></li>
<li class="chapter" data-level="8.4" data-path="data-preprocessing-1.html"><a href="data-preprocessing-1.html#select-calibration-set-1"><i class="fa fa-check"></i><b>8.4</b> Select Calibration Set</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Soil Predictions using MIR-Spectroscopy</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-preprocessing-1" class="section level1">
<h1><span class="header-section-number">8</span> Data Preprocessing</h1>
<div id="extract-opus-files-1" class="section level2">
<h2><span class="header-section-number">8.1</span> Extract OPUS files</h2>
<p>For Bruker Instruments, an OPUS file containing spectral data, will be output for each sample that is scanned. To compile these separate files into one dataset, we use a couple functions from the <a href="https://github.com/philipp-baumann/simplerspec">‘simplerspec’</a> package by Philip Baumann, as well as the stringr and foreach packages.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="co">#---Packages---#</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="kw">library</span>(stringr) <span class="co">#used for str_sub</span></a>
<a class="sourceLine" id="cb31-3" data-line-number="3"><span class="kw">library</span>(foreach) <span class="co">#used within read-opus-universal.R</span></a>
<a class="sourceLine" id="cb31-4" data-line-number="4"><span class="kw">source</span>(<span class="st">&quot;Single_Lib/reference_files/gather-spc.R&quot;</span>) <span class="co">#simplerspec function</span></a>
<a class="sourceLine" id="cb31-5" data-line-number="5"><span class="kw">source</span>(<span class="st">&quot;Single_Lib/reference_files/read-opus-universal.R&quot;</span>) <span class="co">#simplerspec function</span></a></code></pre></div>
<p>Gets the paths of all OPUS files…</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1"><span class="co">#---List Files---#</span></a>
<a class="sourceLine" id="cb32-2" data-line-number="2">spectraPath &lt;-<span class="st"> &quot;/Single_Lib/SPECTRA&quot;</span> <span class="co">#folder of OPUS files</span></a>
<a class="sourceLine" id="cb32-3" data-line-number="3">dirs &lt;-<span class="st"> </span><span class="kw">list.dirs</span>(<span class="kw">paste</span>(<span class="kw">getwd</span>(),spectraPath,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>), <span class="dt">full.names=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb32-4" data-line-number="4">all.files &lt;-<span class="st"> </span><span class="kw">list.files</span>(dirs, <span class="dt">pattern=</span> <span class="st">&quot;*.0&quot;</span>, <span class="dt">recursive=</span><span class="ot">TRUE</span>,<span class="dt">full.names=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<p>Extracts the spectra and gathers it into a tibble data frame…</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="co">#---Extract Spectra---#</span></a>
<a class="sourceLine" id="cb33-2" data-line-number="2">spc_list &lt;-<span class="st"> </span><span class="kw">read_opus_univ</span>(<span class="dt">fnames =</span> all.files, <span class="dt">extract =</span> <span class="kw">c</span>(<span class="st">&quot;spc&quot;</span>))</a>
<a class="sourceLine" id="cb33-3" data-line-number="3">soilspec_tbl &lt;-<span class="st"> </span>spc_list <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-4" data-line-number="4"><span class="st">  </span><span class="kw">gather_spc</span>()</a>
<a class="sourceLine" id="cb33-5" data-line-number="5">spc &lt;-<span class="st"> </span>soilspec_tbl<span class="op">$</span>spc</a></code></pre></div>
<p>Optionally truncates the dataset to ensure the spectra from different samples align. Only necessary if instrument settings are changed between runs. 3017 would be changed to the number of spectral columns (wavelengths collected)</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1">spc &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(spc),<span class="cf">function</span>(x) spc[[x]][,<span class="dv">1</span><span class="op">:</span><span class="dv">3017</span>])</a></code></pre></div>
<p>Processes spectra into a dataframe and assigns a sample_id, based off the file names…<br />
*sample_ids that are numeric may cause issues while merging so a string ID is advised.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1">spc.df &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">matrix</span>(<span class="kw">unlist</span>(spc), <span class="dt">nrow=</span><span class="kw">length</span>(spc), <span class="dt">byrow=</span>T))</a>
<a class="sourceLine" id="cb35-2" data-line-number="2"><span class="kw">colnames</span>(spc.df) &lt;-<span class="st"> </span><span class="kw">colnames</span>(spc[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb35-3" data-line-number="3">spc.df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">sample_id =</span> soilspec_tbl<span class="op">$</span>sample_id, spc.df)</a>
<a class="sourceLine" id="cb35-4" data-line-number="4">spc.df<span class="op">$</span>sample_id &lt;-<span class="st"> </span><span class="kw">str_sub</span>(spc.df<span class="op">$</span>sample_id,<span class="dv">1</span>,<span class="dv">9</span>)</a></code></pre></div>
<p>Optionally saves the spectra as an R dataset or csv file…</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="kw">save</span>(spc.df, <span class="dt">file=</span><span class="st">&quot;spectra_original.RData&quot;</span>)</a>
<a class="sourceLine" id="cb36-2" data-line-number="2"><span class="kw">write.csv</span>(spc.df, <span class="st">&quot;spectra_original.csv&quot;</span>)</a></code></pre></div>
</div>
<div id="process-spectra-1" class="section level2">
<h2><span class="header-section-number">8.2</span> Process Spectra</h2>
<p>We narrow down the regions of the spectra by truncating wavenumbers below 628 and between 2268 to 2389, which is a CO2 sensitive region.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="co">#---Edit Spectral Columns---#</span></a>
<a class="sourceLine" id="cb37-2" data-line-number="2">col.names &lt;-<span class="st"> </span><span class="kw">colnames</span>(spectra<span class="op">$</span>spc) <span class="co">#get column names which are wavenumbers</span></a>
<a class="sourceLine" id="cb37-3" data-line-number="3">col.names &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">substring</span>(col.names,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb37-4" data-line-number="4"></a>
<a class="sourceLine" id="cb37-5" data-line-number="5">cutoff &lt;-<span class="st"> </span><span class="kw">which</span>(col.names <span class="op">&lt;=</span><span class="st"> </span><span class="dv">628</span>)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb37-6" data-line-number="6">spectra<span class="op">$</span>spc &lt;-<span class="st"> </span>spectra<span class="op">$</span>spc[,<span class="op">-</span><span class="kw">c</span>(cutoff<span class="op">:</span><span class="kw">length</span>(col.names))] <span class="co">#truncate at &gt;= 628</span></a>
<a class="sourceLine" id="cb37-7" data-line-number="7"></a>
<a class="sourceLine" id="cb37-8" data-line-number="8">min.index &lt;-<span class="st"> </span><span class="kw">which</span>(col.names <span class="op">&lt;=</span><span class="st"> </span><span class="dv">2389</span>)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb37-9" data-line-number="9">max.index &lt;-<span class="st"> </span><span class="kw">which</span>(col.names <span class="op">&lt;=</span><span class="st"> </span><span class="dv">2268</span>)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb37-10" data-line-number="10">spectra<span class="op">$</span>spc &lt;-<span class="st"> </span>spectra<span class="op">$</span>spc[,<span class="op">-</span><span class="kw">c</span>(min.index<span class="op">:</span>max.index)] <span class="co">#remove CO2 region</span></a></code></pre></div>
<p>We perform a baseline transformation to normalize the spectra</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1"><span class="co">#---Baseline Transformation---#</span></a>
<a class="sourceLine" id="cb38-2" data-line-number="2"><span class="kw">library</span>(matrixStats)</a>
<a class="sourceLine" id="cb38-3" data-line-number="3">base_offset &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb38-4" data-line-number="4">  test &lt;-<span class="st"> </span><span class="kw">rowMins</span>(x)</a>
<a class="sourceLine" id="cb38-5" data-line-number="5">  <span class="kw">return</span>(x<span class="op">-</span>test)</a>
<a class="sourceLine" id="cb38-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb38-7" data-line-number="7">spectra<span class="op">$</span>spc &lt;-<span class="st"> </span><span class="kw">base_offset</span>(spectra<span class="op">$</span>spc)</a></code></pre></div>
<p>Optionally saves the processed spectra as an R dataset or csv file…</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="co">#---Save Spectra---#</span></a>
<a class="sourceLine" id="cb39-2" data-line-number="2"><span class="kw">save</span>(spc.df, <span class="dt">file=</span><span class="st">&quot;Single_Lib/spectra_processed.RData&quot;</span>)</a>
<a class="sourceLine" id="cb39-3" data-line-number="3"><span class="kw">write.csv</span>(spc.df, <span class="st">&quot;Single_Lib/spectra_processed.csv&quot;</span>)</a></code></pre></div>
<!--could show head of the spectra, or a figure showing the dimensions-->
</div>
<div id="merge-with-lab-data-1" class="section level2">
<h2><span class="header-section-number">8.3</span> Merge with Lab Data</h2>
<p>If there is lab data associated with your soil samples, this can be merged with the spectral data and later used to assess the performance of your models.The example lab dataset below provides information about where the soil sample was taken with the Site_ID and Horizon, as well as the lab measurements for various soil properties including Organic Carbon, Sand, Silt and Clay.</p>
<!--discuss FTIR run-lists and associating IDs -->
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1"><span class="co">#---Read Lab Data---#</span></a>
<a class="sourceLine" id="cb40-2" data-line-number="2"><span class="kw">library</span>(readr) <span class="co">#used to open the .csv file</span></a>
<a class="sourceLine" id="cb40-3" data-line-number="3">lab &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">read_csv</span>(<span class="st">&quot;Single_Lib/LAB_DATA.csv&quot;</span>, <span class="dt">col_types=</span><span class="kw">cols</span>())) <span class="co">#read in the lab data</span></a></code></pre></div>
<p>The merge() command joins the lab dataset to the spectral dataset. The all.y=TRUE parameter indicates that the final dataset will contain all the rows of spectra. This means that if some samples do not have lab data, they will be assigned a value of NA but the spectra will remain in the set.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1"><span class="co">#---Merge Data---#</span></a>
<a class="sourceLine" id="cb41-2" data-line-number="2">all_data &lt;-<span class="st"> </span><span class="kw">merge</span>(lab, spectra, <span class="dt">all.y=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb41-3" data-line-number="3"><span class="kw">save</span>(all_data, <span class="dt">file=</span><span class="st">&quot;Single_Lib/spectra_lab_merge.RData&quot;</span>)</a>
<a class="sourceLine" id="cb41-4" data-line-number="4"><span class="kw">write.csv</span>(all_data, <span class="st">&quot;Single_Lib/spectra_lab_merge.csv&quot;</span>, <span class="dt">row.names=</span><span class="ot">FALSE</span>)</a></code></pre></div>
<!-- could show the head of this dataset as well -->
<p>The final dataframe contains a unique ID, lab data, and a matrix of spectral data called ‘spc’. It is suggested to save this file as RData so it may be reloaded as needed.</p>
</div>
<div id="select-calibration-set-1" class="section level2">
<h2><span class="header-section-number">8.4</span> Select Calibration Set</h2>
<p>{<strong>OPTIONAL</strong>}</p>
<p>Once the full dataset is processed, it must be split into calibration and validation sets to that will be used to train and test the model. This process must be repeated for each soil property that is being predicted, since outliers and NA values may vary among the properties. The example below shows this step for a single property, while the RUNFILE code shows it implemented in a loop for several properties.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1"><span class="co">#---Packages---#</span></a>
<a class="sourceLine" id="cb42-2" data-line-number="2"><span class="kw">library</span>(pls) <span class="co">#used for plsr model</span></a>
<a class="sourceLine" id="cb42-3" data-line-number="3"><span class="kw">source</span>(<span class="st">&quot;Single_Lib/reference_files/functions_modelChoice.R&quot;</span>) <span class="co">#used for optimum_sd_outlier()</span></a></code></pre></div>
<p>Rows that have NA or negative values for the property being predicted (% Organic Carbon) are excluded from the dataset.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1"><span class="co">#---Eliminate NA &amp; negative---#</span></a>
<a class="sourceLine" id="cb43-2" data-line-number="2">all_data &lt;-<span class="st"> </span>all_data[<span class="op">!</span><span class="kw">is.na</span>(all_data[,property]),] <span class="co">#no NAs</span></a>
<a class="sourceLine" id="cb43-3" data-line-number="3">all_data &lt;-<span class="st"> </span>all_data[<span class="kw">which</span>(all_data[,property] <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>),] <span class="co">#no negative values</span></a></code></pre></div>
<p>A pls model is created from the remaining data to flag outliers. Samples that have inaccurate predictions are excluded. This is measured by regressing the predictions against its associated lab data, and evaluating how many standard deviations each sample is from the best fit line. Those &gt;99th percentile are removed since…</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="co">#---Remove Outliers---#</span></a>
<a class="sourceLine" id="cb44-2" data-line-number="2">pls.fit &lt;-<span class="st"> </span><span class="kw">plsr</span>(<span class="kw">sqrt</span>(<span class="kw">get</span>(property))<span class="op">~</span>spc, <span class="dt">ncomp=</span> <span class="dv">20</span>, <span class="dt">data =</span> all_data, <span class="dt">valid=</span><span class="st">&quot;CV&quot;</span>, <span class="dt">segments =</span> <span class="dv">50</span>) <span class="co">#fit a pls model to the data</span></a>
<a class="sourceLine" id="cb44-3" data-line-number="3">pred &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">predict</span>(pls.fit, <span class="dt">newdata =</span> all_data<span class="op">$</span>spc,<span class="dt">ncomp=</span><span class="dv">20</span>))<span class="op">^</span><span class="dv">2</span> <span class="co">#make predictions</span></a>
<a class="sourceLine" id="cb44-4" data-line-number="4">sd.outlier &lt;-<span class="st"> </span><span class="kw">optimum_sd_outlier</span>(pred, all_data[,property], <span class="kw">seq</span>(<span class="fl">0.1</span>,<span class="dv">3</span>, <span class="dt">by =</span><span class="fl">0.02</span>)) <span class="co">#flag samples that performed poorly as outliers</span></a>
<a class="sourceLine" id="cb44-5" data-line-number="5">row.index &lt;-<span class="st"> </span><span class="kw">outlier</span>(pred, all_data[,property], sd.outlier[<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb44-6" data-line-number="6"><span class="cf">if</span>(<span class="kw">length</span>(row.index) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>){</a>
<a class="sourceLine" id="cb44-7" data-line-number="7">  all_data &lt;-<span class="st"> </span>all_data[row.index,] <span class="co">#subset non-outliers</span></a>
<a class="sourceLine" id="cb44-8" data-line-number="8">}</a></code></pre></div>
<!--Insert plot showing the outlier selection process-->
<p>Performing kennard stone to separate data into 80% calibration and 20% validation sets. This step can be skipped if using MBL modeling approach which uses the entire dataset. If both modeling approaches are being used, you can load and row bind the calibration and validation sets for MBL.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1"><span class="co">#---Kennard Stone---#</span></a>
<a class="sourceLine" id="cb45-2" data-line-number="2">ken_stone&lt;-<span class="st"> </span>prospectr<span class="op">::</span><span class="kw">kenStone</span>(<span class="dt">X =</span> all_data<span class="op">$</span>spc, <span class="dt">k =</span> <span class="kw">as.integer</span>(<span class="fl">0.8</span><span class="op">*</span><span class="kw">nrow</span>(all_data)), <span class="dt">metric =</span> <span class="st">&quot;mahal&quot;</span>, <span class="dt">pc =</span> <span class="dv">10</span>) </a>
<a class="sourceLine" id="cb45-3" data-line-number="3">calib &lt;-<span class="st"> </span>all_data[ken_stone<span class="op">$</span>model, ] <span class="co">#subset calibration set</span></a>
<a class="sourceLine" id="cb45-4" data-line-number="4">valid &lt;-<span class="st"> </span>all_data[ken_stone<span class="op">$</span>test, ] <span class="co">#subset validation set</span></a></code></pre></div>
<p>Save calibration and validation set for that particular property</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="co">#Save for property</span></a>
<a class="sourceLine" id="cb46-2" data-line-number="2"><span class="kw">save</span>(calib, <span class="dt">file=</span><span class="kw">paste</span>(<span class="st">&quot;Single_Lib/calib&quot;</span>,property,<span class="st">&quot;RData&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;.&quot;</span>))</a>
<a class="sourceLine" id="cb46-3" data-line-number="3"><span class="kw">save</span>(valid, <span class="dt">file=</span><span class="kw">paste</span>(<span class="st">&quot;Single_Lib/valid&quot;</span>,property,<span class="st">&quot;RData&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;.&quot;</span>))</a></code></pre></div>
<p>An alternative to saving the datasets would be to add a column indicating whether a sample falls under the calibration or validation set. This could be used to subset the correct datasets when making predictions. If the full dataset is large and takes a while to load, saving the former approach is preferred. If the set loads relatively quickly, it may be worth it to save storage space and use the latter method.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="references.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "sepia",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>

<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 PLSR Models | Soil Predictions using MIR-Spectroscopy</title>
  <meta name="description" content="5 PLSR Models | Soil Predictions using MIR-Spectroscopy" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="5 PLSR Models | Soil Predictions using MIR-Spectroscopy" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 PLSR Models | Soil Predictions using MIR-Spectroscopy" />
  
  
  

<meta name="author" content="Charlotte Rivard" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="data-preprocessing.html"/>
<link rel="next" href="mbl-models.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Soil Predictions using MIR-Spectroscopy</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="background.html"><a href="background.html"><i class="fa fa-check"></i><b>2</b> Background</a></li>
<li class="chapter" data-level="3" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>3</b> Getting Started</a><ul>
<li class="chapter" data-level="3.1" data-path="getting-started.html"><a href="getting-started.html#file-walkthrough"><i class="fa fa-check"></i><b>3.1</b> File Walkthrough</a></li>
<li class="chapter" data-level="3.2" data-path="getting-started.html"><a href="getting-started.html#required-packages"><i class="fa fa-check"></i><b>3.2</b> Required Packages</a></li>
<li class="chapter" data-level="3.3" data-path="getting-started.html"><a href="getting-started.html#full-script"><i class="fa fa-check"></i><b>3.3</b> Full Script</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-preprocessing.html"><a href="data-preprocessing.html"><i class="fa fa-check"></i><b>4</b> Data Preprocessing</a><ul>
<li class="chapter" data-level="4.1" data-path="data-preprocessing.html"><a href="data-preprocessing.html#extract-opus-files"><i class="fa fa-check"></i><b>4.1</b> Extract OPUS files</a></li>
<li class="chapter" data-level="4.2" data-path="data-preprocessing.html"><a href="data-preprocessing.html#process-spectra"><i class="fa fa-check"></i><b>4.2</b> Process Spectra</a><ul>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#subset-spectral-range"><i class="fa fa-check"></i>Subset Spectral Range</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#baseline-transformation"><i class="fa fa-check"></i>Baseline Transformation</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#other-transformations"><i class="fa fa-check"></i>Other Transformations</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#calibration-transfer"><i class="fa fa-check"></i>(Calibration Transfer)</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="data-preprocessing.html"><a href="data-preprocessing.html#merge-with-lab-data"><i class="fa fa-check"></i><b>4.3</b> Merge with Lab Data</a></li>
<li class="chapter" data-level="4.4" data-path="data-preprocessing.html"><a href="data-preprocessing.html#refine-reference-set"><i class="fa fa-check"></i><b>4.4</b> (Refine Reference Set)</a><ul>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#large-sets"><i class="fa fa-check"></i>Large Sets</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#faulty-lab-data"><i class="fa fa-check"></i>Faulty Lab Data</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#outliers"><i class="fa fa-check"></i>Outliers</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#calval-groups"><i class="fa fa-check"></i>Cal/Val Groups</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="plsr-models.html"><a href="plsr-models.html"><i class="fa fa-check"></i><b>5</b> PLSR Models</a><ul>
<li class="chapter" data-level="5.1" data-path="plsr-models.html"><a href="plsr-models.html#model-theory"><i class="fa fa-check"></i><b>5.1</b> Model Theory</a></li>
<li class="chapter" data-level="5.2" data-path="plsr-models.html"><a href="plsr-models.html#making-plsr-models"><i class="fa fa-check"></i><b>5.2</b> Making PLSR Models</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="mbl-models.html"><a href="mbl-models.html"><i class="fa fa-check"></i><b>6</b> MBL Models</a><ul>
<li class="chapter" data-level="6.1" data-path="mbl-models.html"><a href="mbl-models.html#model-theory-1"><i class="fa fa-check"></i><b>6.1</b> Model Theory</a><ul>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#overview"><i class="fa fa-check"></i>Overview</a></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#animation"><i class="fa fa-check"></i>Animation</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="mbl-models.html"><a href="mbl-models.html#making-mbl-predictions"><i class="fa fa-check"></i><b>6.2</b> Making MBL Predictions</a><ul>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#mbl-functions"><i class="fa fa-check"></i>MBL Functions</a></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#modeling-parameters"><i class="fa fa-check"></i>Modeling Parameters</a></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#sample-code"><i class="fa fa-check"></i>Sample Code</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="model-performance.html"><a href="model-performance.html"><i class="fa fa-check"></i><b>7</b> Model Performance</a><ul>
<li class="chapter" data-level="7.1" data-path="model-performance.html"><a href="model-performance.html#statistics"><i class="fa fa-check"></i><b>7.1</b> Statistics</a></li>
<li class="chapter" data-level="7.2" data-path="model-performance.html"><a href="model-performance.html#plots"><i class="fa fa-check"></i><b>7.2</b> Plots</a></li>
<li class="chapter" data-level="7.3" data-path="model-performance.html"><a href="model-performance.html#outliers-1"><i class="fa fa-check"></i><b>7.3</b> Outliers</a><ul>
<li class="chapter" data-level="7.3.1" data-path="model-performance.html"><a href="model-performance.html#standard-deviation"><i class="fa fa-check"></i><b>7.3.1</b> Standard Deviation</a></li>
<li class="chapter" data-level="7.3.2" data-path="model-performance.html"><a href="model-performance.html#f-ratio"><i class="fa fa-check"></i><b>7.3.2</b> F-Ratio</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Soil Predictions using MIR-Spectroscopy</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="plsr-models" class="section level1">
<h1><span class="header-section-number">5</span> PLSR Models</h1>
<div id="model-theory" class="section level2">
<h2><span class="header-section-number">5.1</span> Model Theory</h2>
<ul>
<li><strong>Partial Least Squares Regression</strong> (PLSR) is a useful technique for making predictions on high dimensional datasets; Those with many columns or predictor variables relative to the number of rows or instances.
<ul>
<li>For example, we are using <strong>2720 columns</strong> of spectral data as predictor variables for only <strong>333 rows</strong> of samples in the script to follow.<br />
</li>
<li>A simple regression model would have the issue of overfitting and thus would not be suitable for this dataset.<br />
</li>
</ul></li>
<li><p>PLSR models, like Principal Component Analysis (PCA), <strong>reduce the dimensionality</strong> of the dataset by creating new set of orthogonal variables that explain the most variation in the data.</p></li>
<li>However, instead of <strong>optimizing covariance</strong> amoung only the predictor variables, in this case the spectra, PLS optimizes covariance between the predictors and the response variable, the soil property of interest.
<ul>
<li>To learn more about PLS, check out this youtube video: <a href="%22https://www.youtube.com/watch?v=AxmqUKYeD-U%22">PLS Introductory Video</a></li>
</ul></li>
</ul>
<!-- These come in the form of scores and loadings {explain contrast with PCA} -->
<!--vocab: orthogonal, high dimensional, latent variables- have links to define orthogonal-->
</div>
<div id="making-plsr-models" class="section level2">
<h2><span class="header-section-number">5.2</span> Making PLSR Models</h2>
<ul>
<li>To predict using PLSR models, we use the <a href="https://cran.r-project.org/web/packages/pls/vignettes/pls-manual.pdf">pls package in r</a></li>
</ul>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="co">#---Packages---#</span></a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="kw">library</span>(pls)</a></code></pre></div>
<ul>
<li>Assuming you have exited the environment where you pre-processed spectra, reload your calibration and validation sets.</li>
</ul>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="co">#---Load Data---#</span></a>
<a class="sourceLine" id="cb28-2" data-line-number="2"><span class="kw">load</span>(<span class="st">&quot;Single_Lib/calib.OC.RData&quot;</span>)</a>
<a class="sourceLine" id="cb28-3" data-line-number="3"><span class="kw">load</span>(<span class="st">&quot;Single_Lib/valid.OC.RData&quot;</span>)</a></code></pre></div>
<ul>
<li>The <code>plsr()</code> command creates a model based on several inputs, outlined in the
full documentation found here: <em><a href="https://www.rdocumentation.org/packages/pls/versions/2.7-2/topics/mvr" class="uri">https://www.rdocumentation.org/packages/pls/versions/2.7-2/topics/mvr</a></em><br />
and the manual, here: <em><a href="https://cran.r-project.org/web/packages/pls/pls.pdf" class="uri">https://cran.r-project.org/web/packages/pls/pls.pdf</a></em><br />
</li>
<li>Used in this example we have…
<ul>
<li><code>Y</code> The lab data/ observed data for the soil property you are trying to predict. We chose to square root transform this variable to normalize the data. Predictions made my the model are squared to back transform them.<br />
</li>
<li><code>X</code> A matrix of spectra with the same number of rows as Y<br />
</li>
<li><code>ncomp</code> The number of components that you would like to include in the model<br />
</li>
<li><code>data</code> The dataset containing Y and X<br />
</li>
<li><code>valid</code> The preferred validation type (“LOO”,“CV”,“none”)
<ul>
<li><code>LOO</code> for leave-one out</li>
<li><code>CV</code> for cross validation</li>
<li><code>none</code> if you chose not to include validation</li>
</ul></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="co">#---Create Model---#</span></a>
<a class="sourceLine" id="cb29-2" data-line-number="2">plsr.model &lt;-<span class="st"> </span><span class="kw">plsr</span>(<span class="kw">sqrt</span>(<span class="kw">get</span>(property))<span class="op">~</span>spc, <span class="dt">ncomp=</span><span class="dv">20</span>, <span class="dt">data =</span> calib, <span class="dt">valid=</span><span class="st">&quot;LOO&quot;</span>)</a>
<a class="sourceLine" id="cb29-3" data-line-number="3"><span class="kw">save</span>(plsr.model, <span class="dt">file =</span> <span class="kw">paste</span>(<span class="st">&quot;plsr&quot;</span>, property,<span class="st">&quot;.RData&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) <span class="co">#saving the model</span></a></code></pre></div>
<!--Explain ncomp one sigma, how predictions are stored in plsr.model, do predictions on both calibration and validation data. 
Flag which are cal and val for each property. define valid in this file as where OC.cal==1. (Saves storage space, compromise is possibly runtime of getting that subset? But it seems like its quicker than loading all the data again)-->
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="co">#---Applying Model---#</span></a>
<a class="sourceLine" id="cb30-2" data-line-number="2">ncomp.onesigma &lt;-<span class="st"> </span><span class="kw">selectNcomp</span>(plsr.model, <span class="dt">method =</span> <span class="st">&quot;onesigma&quot;</span>, <span class="dt">plot =</span> <span class="ot">TRUE</span>, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">50</span>))</a>
<a class="sourceLine" id="cb30-3" data-line-number="3">predVals &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">predict</span>(plsr.model, <span class="dt">newdata =</span> predDat<span class="op">$</span>spc, <span class="dt">ncomp=</span>ncomp.onesigma))<span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb30-4" data-line-number="4">savename &lt;-<span class="st"> </span><span class="kw">paste</span>(property, modelType, predDatName, <span class="kw">paste</span>(<span class="st">&quot;v&quot;</span>,datname,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>), <span class="dt">sep=</span><span class="st">&quot;.&quot;</span>)</a></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data-preprocessing.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="mbl-models.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "sepia",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
